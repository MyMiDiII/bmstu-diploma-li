\chapter{\label{research}Исследовательская часть}

\section{Предмет исследования}

Характеристиками, определяющими эффективность индекса являются:

\begin{itemize}
    \item время выполнения основных операций:
\begin{itemize}[wide=\dimexpr\parindent-2em+\labelsep\relax, leftmargin=* ]
    \item построения;
    \item поиска;
    \item вставки (являющейся
        комбинацией первых двух операций);
\end{itemize}
    \item память, занимаемая индексом.
\end{itemize}

Так как метод основан на использовании глубокой нейронной сети,
характеристикой также является средняя абсолютная ошибка предсказания позиции
ключей, получаемая в ходе обучения.

Предполагается зависимость описанных характеристик от объема индексируемых
данных, а также от распределения ключей, поэтому исследование проводится на
различном количестве ключей для распределений, описанных в
подразделе~\ref{data}: равномерного, нормального и распределения реальных данных
OpenStreetMap. Также проводится сравнение времени поиска при моделях с различным
числом скрытых слоев, описанных в подразделе~\ref{dnn}.

\section{Исследование времени построения индекса}

На рисунке~\ref{img:res-build-distr} приведен график зависимости времени
построения индекса от количества ключей в индексируемом наборе данных при
различных распределениях с использованием модели с двумя скрытыми слоями.

\imgw{res-build-distr}{h!}{17cm}{График зависимости времени построения
индекса от количества ключей (распределения, 2 скрытых слоя)}

На рисунке~\ref{img:res-build} приведен график зависимости времени построения
индекса от количества ключей в индексируемом наборе реальных данных при
различных количествах скрытых слоев в модели.

\imgw{res-build}{h!}{17cm}{График зависимости времени построения
индекса от количества ключей (модели, реальные данные)}

Из приведенных графиков можно сделать вывод, что распределение данных не
оказывает влияние на время построения индекса в силу необходимости прохода по
всему набору данных при обучении. При этом добавление дополнительного слоя в
модель увеличивает время обучения, а следовательно и построения. По сравнению с
индексом на основе модели с двумя скрытыми слоями индекс на основе модели с
тремя увеличивает время построения на~10\%.

Основным выводом из приведенных графиков является наблюдаемая линейная
зависимость времени построения индекса от количества ключей в наборе, что
объясняется достижением необходимой точности модели за \mbox{1-2~эпохи} обучения
при каждом размере данных, за которые проиходит проход по всем значениям ключей.

\section{Исследование времени поиска}

На время поиска с использованием индекса, построенного с помощью разработанного
метода, должна оказывать влияние абсолютная ошибка предсказания позиции ключа
моделью глубокой нейронной сети, так как она определяет диапазон, в котором
осуществляется уточнение с помощью бинарного поиска, поэтому в дополнение к
исследованию зависимости времени поиска от количества ключей было также
проведено исследование зависимости среденей абсолютной ошибки от количества
ключей.

На рисунка~\ref{img:res-error-distrs} и \ref{img:res-search-distrs} приведены
графики зависимостей среденей абсолютно ошибки и времени поиска от количества
ключей при различных распределениях с использованием модели с двумя скрытыми
слоями.

\imgw{res-error-distrs}{h!}{17cm}{График зависимости средней абсолютной ошибки 
от количества ключей (распределения, 2 скрытых слоя)}

\imgw{res-search-distrs}{h!}{16cm}{График зависимости времени поиска 
от количества ключей (распределения, 2 скрытых слоя)}

По графикам на данных, распределенных по равномерному закону, функция
распределения которых является линейной, имеет наименьшее значение абсолютной
ошибки и, как следствие, меньшее время поиска. Наибольшая абсолютная ошибка и
время поиска наблюдаются на реальных данных, так как их функция распределения
имеет более сложный вид нежели классические распредления. Однако при росте
ошибки на~0.2\% относительно равномерного распределения, время поиска на
реальных данных увеличивается в среднем на~6\%.

При этом при увеличении числа ключей отношение средней абсолютной ошибке к
количеству ключей стремится к некотором постоянному значению, то есть диапазон
бинарного поиска будет составлять некоторую постоянную часть от числа ключей, то
есть будет линейно расти.

На рисунка~\ref{img:res-error-2vs3} и \ref{img:res-search-2vs3} приведены
графики зависимостей среденей абсолютно ошибки и времени поиска от количества
ключей при реальных данных с использованием моделей с двумя и тремя слоями.

\imgw{res-error-2vs3}{h!}{16cm}{График зависимости средней абсолютной ошибки 
от количества ключей (модели, реальные данные)}

\imgw{res-search-2vs3}{h!}{17cm}{График зависимости времени поиска 
от количества ключей (модели, реальные данные)}

Таким образом, добавлении третьего слоя оказалось неоправданным, достигаемое
уменьшение средней абсолютной ошибки на~0.06\% и уменьшение времени бинарного
поиска превысилось временем, затрачиваемым на подсчет дополнительных
коэффициентов третьего слоя при предсказании.

На рисунке~\ref{img:res-search-steps} представлен график зависимости времени
поиска и его этапов (предсказания и уточнения) от числа ключей на реальных
данных с использованием модели с двумя скрытыми слоями.

\imgw{res-search-steps}{h!}{16cm}{График зависимости времени поиска,
предсказания и уточнения от количества ключей (реальные данные, 2 скрытых слоя)}

Таким образом, предсказание выполняется за постоянное время, которое больше
времени выполнения бинарного поиска с временной сложностью $O(log N)$. Таким
образом, сложность поиска с использованием индекса, построенного разработанным
методом, $O(log N)$. При этом коэффициент при $N$ равен величине отношения
средней абсолютной ошибки к числу ключей, которая составляет 0.2\%.

Для оценки худшего случая построим нормированное распределение абсолютной
ошибки, которое представлено на рисунке~\ref{img:res-histogram}.

\imgw{res-histogram}{h!}{17cm}{Распределение абсолютной ошибки предсказания
позиции}

Из графика можно сделать вывод, что максимальная абсолютная ошибка составляет
0.6\% от числа ключей, то есть в худшем случае бинарный поиск будет осуществляться
в дапазоне $0.006N$.

%TIME NO INDEX
%[33810.893, 34174.073, 46409.604, 63999.267, 49323.193, 44860.572, 40802.64, 49927.724, 43546.585, 52984.766]
%TIME INDEX
%[19541.589, 20174.844, 51743.322, 38052.981, 54306.699, 30575.293, 51177.327, 41055.075, 47446.482, 32067.956]
%TIME INSERT
%[6450.102, 33057.749, 83873.912, 96660.027, 116369.553, 86314.484, 151797.418, 130966.508, 129088.006, 154662.577]
%[163840, 8671232, 46854144, 150663168, 306233344, 461594624, 772362240, 1083125760, 1393795072, 1549508608]

\section{Исследование времени вставки}

На рисунке~\ref{img:res-insert} представлен график зависимости времени вставки
от числа ключей.

\imgw{res-insert}{h!}{17cm}{График зависимости времени вставки от количества
ключей (реальные данные, 2 скрытых слоя)}

Вставка представляет собой комбинацию поиска и построения индекса, поэтому
зависимость является линейой, как у построения.

\section{Исследование памяти, используемой индексом}

%На рисунке~\ref{img:res-memory} представлен график зависимости размера индекса
%от количества ключей.
%
%\imgw{res-memory}{h!}{17cm}{График зависимости дополнительной памяти, занимаемой
%индесом, от количества ключей}

На рисунке~\ref{img:res-memory-sqlite} представлен график зависимости размера индекса
от количества ключей.

\imgw{res-memory-sqlite}{h!}{17cm}{График зависимости дополнительной памяти,
занимаемой индесом, от количества ключей}

Индекс, построенный разработанным методом, занимает место только под хранение
модели, имеющей постоянный размер, который не зависит от числа ключей, и под два
массива, память под который увеличивается линейно. То есть, если учитывать
только память, выделяемую на поддержку структуры индекса, разработанный индекс
имеет постоянный размер, соответсвующий размеру модели нейронной сети, в отличие
от традиционных индексов, в которых выделяется память под указатели для
поддержки структуры, число которых зависит от числа ключей. 

\section{Результаты исследования}

В ходе исследования были сделаны следующие выводы:
\begin{itemize}
    \item временная сложность построения $O(N)$;
    \item средняя абсолютная ошибка предсказания модели стремится к некоторому
        постоянному значению по отношению к общему числу ключей, что дает
        линейную зависимость размера диапазона для бинарного поиска от числа
        ключей, причем с малым коэффициентом, равным $0.002$ --- в среднем 
        случае, и $0.006$ --- в худшем для реальных данных;
    \item разработанный индекс имеет временную сложность поиска $O(\log N)$;
    \item временная сложность вставки составляет $O(N)$;
    \item разработанный индекс затрачивает на поддержание своей структуры не
        зависящее от числа данных количество памяти;
    \item с учетом хранимых ключей и указателей, память, затрачиваемая индексом,
        линейно растет при увеличении числа индексируемых ключей;
    \item увеличение точность путем добавления дополнительных слоев в нейронную
        сеть не оправданно из-за роста затрат на вычисления дополнительных
        коэффициентов третьего слоя;
    \item индекс быстрее работает на классических распредлениях.
\end{itemize}

